<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Calculators</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 13px;
            background: #0d0d0d;
            color: #d0d0d0;
            padding: 8px;
        }
        .tab-wrapper {
            max-width: 1200px;
            margin: 0 auto;
        }
        .tab-header {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
        }
        .tab-button {
            flex: 1;
            padding: 10px 12px;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            color: #d0d0d0;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }
        .tab-button.active {
            background: #5cb3ff;
            color: #fff;
            border-color: #5cb3ff;
            box-shadow: 0 2px 8px rgba(92,179,255,0.4);
        }
        .tab-content {
            position: relative;
        }
        .tab-panel {
            display: none;
        }
        .tab-panel.active {
            display: block;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: #1a1a1a;
            border-radius: 6px;
            padding: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.8);
            border: 1px solid #2a2a2a;
        }
        h2 {
            font-size: 18px;
            margin-bottom: 10px;
            color: #5cb3ff;
            text-align: center;
        }
        .section {
            margin-bottom: 10px;
            padding: 8px;
            background: #141414;
            border-radius: 4px;
            border: 1px solid #2a2a2a;
        }
        .inputs-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0px;
        }
        .input-group {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            margin: 5px 0;
            font-size: 12px;
            column-gap: 6px;
        }
        .input-group.full-width {
            grid-column: 1 / -1;
        }
        label {
            flex: 1;
            color: #a0a0a0;
            margin-right: 6px;
        }
        input {
            width: 120px;
            padding: 5px 10px;
            background: #0d0d0d;
            border: 1px solid #333;
            border-radius: 3px;
            color: #d0d0d0;
            font-size: 12px;
        }
        input:focus {
            outline: none;
            border-color: #5cb3ff;
            background: #151515;
        }
        .extra-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .extra-row {
            display: flex;
            gap: 8px;
            align-items: center;
            background: #0f0f0f;
            padding: 6px;
            border-radius: 4px;
            border: 1px solid #222;
        }
        .extra-field {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 120px;
        }
        .extra-field label {
            font-size: 11px;
            color: #a0a0a0;
            margin-bottom: 2px;
        }
        .extra-field input {
            width: 100%;
        }
        .extra-remove {
            background: #ff5c5c;
            border: none;
            color: #fff;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
        }
        .extra-remove:hover {
            background: #ff4242;
        }
        .result {
            display: flex;
            justify-content: space-between;
            margin: 4px 0;
            padding: 5px 10px;
            background: #0f0f0f;
            border-radius: 3px;
            font-size: 12px;
            border: 1px solid #222;
        }
        .result-label {
            color: #777;
        }
        .result-value {
            color: #5cb3ff;
            font-weight: bold;
        }
        .divider {
            height: 1px;
            background: #2a2a2a;
            margin: 6px 0;
        }
        .section-title {
            font-size: 13px;
            color: #e0e0e0;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .rounds-table-container,
        .table-container {
            max-height: 400px;
            overflow-x: auto;
            overflow-y: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            background: #141414;
            margin-top: 10px;
        }
        thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        th {
            background: #1a1a1a;
            color: #5cb3ff;
            padding: 10px 8px;
            text-align: center;
            font-weight: bold;
            border: 1px solid #2a2a2a;
            white-space: nowrap;
            font-size: 11px;
        }
        td {
            padding: 8px;
            border: 1px solid #2a2a2a;
            color: #d0d0d0;
            background: #0f0f0f;
            text-align: right;
            font-size: 11px;
        }
        tbody tr:nth-child(even) {
            background: #141414;
        }
        tbody tr:hover {
            background: #1a1a1a;
        }
        .round-number {
            background: #252525 !important;
            color: #5cb3ff;
            font-weight: bold;
            text-align: center;
        }
        .num-rounds-input {
            margin-bottom: 6px;
        }
        button {
            padding: 8px 16px;
            background: #5cb3ff;
            color: #fff;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 10px;
            font-weight: bold;
            transition: background 0.2s;
        }
        button:hover {
            background: #4a9eff;
        }
        button:active {
            background: #3d8cef;
        }
        .summary div {
            margin: 4px 0;
            padding: 4px 8px;
            background: #0f0f0f;
            border-radius: 3px;
            font-size: 12px;
            color: #d0d0d0;
        }
        .summary b {
            color: #5cb3ff;
        }
    </style>
</head>
<body>
    <div class="tab-wrapper">
        <div class="tab-header">
            <button class="tab-button active" data-tab="tab-grid">Grid Calculator</button>
            <button class="tab-button" data-tab="tab-loan">Loan Calculator</button>
        </div>
        <div class="tab-content">
            <div id="tab-grid" class="tab-panel active">
                <div class="container">
                    <h2>Calculate Grid App</h2>
                    <div class="section">
            <div class="section-title">Inputs</div>
            <div class="inputs-container">
                <div class="input-group">
                    <label>Entry THB:</label>
                    <input type="number" id="cv" class="grid-input" value="34" step="0.5">
                </div>
                <div class="input-group">
                    <label>Entry USD:</label>
                    <input type="number" id="entry" class="grid-input" value="14" step="0.5">
                </div>
                <div class="input-group">
                    <label>ทุนทั้งหมด:</label>
                    <input type="number" id="startpTH" class="grid-input" value="90000" step="10000">
                </div>
                <div class="input-group">
                    <label>จุดซื้อลงมาทุกๆ %:</label>
                    <input type="number" id="downEntry" class="grid-input" value="0.5" step="0.1">
                </div>
                <div class="input-group">
                    <label>รองรับการล่วง%:</label>
                    <input type="number" id="supportDrawdown" class="grid-input" value="92" step="1">
                </div>
                <div class="input-group">
                    <label>ทำกำไร %:</label>
                    <input type="number" id="pf" class="grid-input" value="1.4" step="0.1">
                </div>
                <div class="input-group">
                    <label>Number Order:</label>
                    <input type="number" id="numberOrder" class="grid-input" value="100" step="1">
                </div>
                <div class="input-group">
                    <label>จำนวนวันที่คำนวน:</label>
                    <input type="number" id="perday" class="grid-input" value="5" step="1">
                </div>
                <div class="input-group num-rounds-input full-width">
                    <label>รอบเดือน:</label>
                    <input type="number" id="numRounds" class="grid-input" value="12" step="1" min="1">
                </div>
            </div>
        </div>

        <div class="divider"></div>

        <div class="section">
            <div class="section-title">Price Calculations</div>
            <div class="result">
                <span class="result-label">Startp USD:</span>
                <span class="result-value" id="startpUSD">0</span>
            </div>
            <div class="result">
                <span class="result-label">จำนวนOrderที่รองรับ:</span>
                <span class="result-value" id="pd">0</span>
            </div>
            <div class="result">
                <span class="result-label">DD is USD:</span>
                <span class="result-value" id="ddUSD">0</span>
            </div>
            <div class="result">
                <span class="result-label">DD is THB:</span>
                <span class="result-value" id="ddTHB">0</span>
            </div>
        </div>

        <div class="divider"></div>

        <div class="section">
            <div class="section-title">Entry & Total</div>
            <div class="result">
                <span class="result-label">Entry TH:</span>
                <span class="result-value" id="entryTH">0</span>
            </div>
            <div class="result">
                <span class="result-label">TT_PF:</span>
                <span class="result-value" id="ttPF">0</span>
            </div>
            <div class="result">
                <span class="result-label">ทุน+กำไรต่อไม้:</span>
                <span class="result-value" id="tt">0</span>
            </div>
            <div class="result">
                <span class="result-label">กำไรเท่านั้น:</span>
                <span class="result-value" id="total">0</span>
            </div>
        </div>

        <div class="divider"></div>

        <div class="section">
            <div class="section-title">Per Day Calculation</div>
            <div class="result">
                <span class="result-label">จำนวนรอบในเดือน:</span>
                <span class="result-value" id="day1Ratio">0</span>
            </div>
            <div class="result">
                <span class="result-label">กำไรรวมทั้งเดือน:</span>
                <span class="result-value" id="day1Total">0</span>
            </div>
        </div>

        <div class="divider"></div>

        <div class="section">
            <div class="section-title">Rounds Calculation Table</div>
            <div class="rounds-table-container">
                <table id="roundsTable">
                    <thead>
                        <tr>
                            <th>Round</th>
                            <th>Entry USD</th>
                            <th>ทุนทั้งหมด</th>
                            <th>Startp USD</th>
                            <th>DD USD</th>
                            <th>DD THB</th>
                            <th>Entry THB</th>
                            <th>TT_PF</th>
                            <th>ทุน+กำไรต่อไม้</th>
                            <th>กำไรเท่านั้น</th>
                            <th>จำนวนรอบในเดือน</th>
                            <th>กำไรรวมทั้งเดือน</th>
                        </tr>
                    </thead>
                    <tbody id="roundsTableBody">
                    </tbody>
                </table>
            </div>
        </div>
                </div>
            </div>
            <div id="tab-loan" class="tab-panel">
                <div class="container">
                    <h2>คำนวณผ่อนเงินกู้ + โปะ</h2>
                    <div class="section">
                        <div class="section-title">ข้อมูลเงินกู้</div>
                        <div class="inputs-container">
                            <div class="input-group">
                                <label>ยอดกู้ (Principal):</label>
                                <input id="principal" type="number" value="90000" step="1000">
                            </div>
                            <div class="input-group">
                                <label>ดอกเบี้ยต่อปี (%):</label>
                                <input id="annualRate" type="number" value="19.99" step="0.01">
                            </div>
                            <div class="input-group">
                                <label>จำนวนงวด (เดือน):</label>
                                <input id="months" type="number" value="60" step="1">
                            </div>
                        </div>
                    </div>
                    <div class="divider"></div>
                    <div class="section">
                        <div class="section-title">โปะเพิ่ม (Extra Payments)</div>
                        <div id="extraPaymentsContainer" class="extra-list"></div>
                        <button type="button" id="addExtraPaymentBtn">+ เพิ่มรายการโปะ</button>
                    </div>
                    <div class="divider"></div>
                    <div class="section summary" id="loanSummary"></div>
                    <div class="section">
                        <div class="section-title">ตารางการผ่อนชำระ</div>
                        <div class="table-container">
                            <table id="loanScheduleTable">
                                <thead>
                                    <tr>
                                        <th>เดือน</th>
                                        <th>ยอดต้นก่อนจ่าย</th>
                                        <th>ค่างวด</th>
                                        <th>ดอกเบี้ย</th>
                                        <th>เงินต้น</th>
                                        <th>โปะเพิ่ม</th>
                                        <th>ยอดคงเหลือ</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const gridInputIds = ['cv', 'entry', 'startpTH', 'downEntry', 'supportDrawdown', 'pf', 'numberOrder', 'perday', 'numRounds'];
        const loanInputIds = ['principal', 'annualRate', 'months'];
        const LOAN_EXTRA_KEY = 'loanExtraPayments';

        const defaultValues = {
            cv: '34',
            entry: '14',
            startpTH: '90000',
            downEntry: '0.5',
            supportDrawdown: '92',
            pf: '1.2',
            numberOrder: '100',
            perday: '5',
            numRounds: '12'
        };
        const defaultExtraPayments = [
            { month: 1, amount: 30000 },
            { month: 2, amount: 10000 }
        ];
        let extraPayments = [];

        function loadExtraPayments() {
            const stored = sessionStorage.getItem(LOAN_EXTRA_KEY);
            if (stored) {
                try {
                    const parsed = JSON.parse(stored);
                    extraPayments = Array.isArray(parsed) ? parsed : [];
                } catch (error) {
                    console.warn('Failed to parse loan extra payments from sessionStorage:', error);
                    extraPayments = [];
                }
            }

            if (!extraPayments.length) {
                extraPayments = defaultExtraPayments.map(extra => ({ ...extra }));
                sessionStorage.setItem(LOAN_EXTRA_KEY, JSON.stringify(extraPayments));
            }

            renderExtraPayments();
        }

        function persistExtraPayments(triggerCalculate = true) {
            sessionStorage.setItem(LOAN_EXTRA_KEY, JSON.stringify(extraPayments));
            if (triggerCalculate) {
                calculateLoanSchedule();
            }
        }

        function renderExtraPayments() {
            const container = document.getElementById('extraPaymentsContainer');
            if (!container) {
                return;
            }

            container.innerHTML = '';

            if (!extraPayments.length) {
                const emptyRow = document.createElement('div');
                emptyRow.className = 'extra-row';
                emptyRow.textContent = 'ยังไม่มีรายการโปะ';
                container.appendChild(emptyRow);
                return;
            }

            extraPayments.forEach((extra, index) => {
                const row = document.createElement('div');
                row.className = 'extra-row';

                const monthField = document.createElement('div');
                monthField.className = 'extra-field';
                const monthLabel = document.createElement('label');
                monthLabel.textContent = 'เดือนที่โปะ';
                const monthInput = document.createElement('input');
                monthInput.type = 'number';
                monthInput.min = '1';
                monthInput.step = '1';
                monthInput.value = extra.month ?? '';
                monthInput.addEventListener('input', () => {
                    extraPayments[index].month = Number(monthInput.value) || 0;
                    persistExtraPayments();
                });
                monthField.appendChild(monthLabel);
                monthField.appendChild(monthInput);

                const amountField = document.createElement('div');
                amountField.className = 'extra-field';
                const amountLabel = document.createElement('label');
                amountLabel.textContent = 'จำนวนเงินโปะ';
                const amountInput = document.createElement('input');
                amountInput.type = 'number';
                amountInput.min = '0';
                amountInput.step = '100';
                amountInput.value = extra.amount ?? '';
                amountInput.addEventListener('input', () => {
                    extraPayments[index].amount = Number(amountInput.value) || 0;
                    persistExtraPayments();
                });
                amountField.appendChild(amountLabel);
                amountField.appendChild(amountInput);

                const removeButton = document.createElement('button');
                removeButton.type = 'button';
                removeButton.className = 'extra-remove';
                removeButton.textContent = 'ลบ';
                removeButton.addEventListener('click', () => {
                    extraPayments.splice(index, 1);
                    renderExtraPayments();
                    persistExtraPayments();
                });

                row.appendChild(monthField);
                row.appendChild(amountField);
                row.appendChild(removeButton);

                container.appendChild(row);
            });
        }

        function addExtraPayment() {
            const nextMonth = extraPayments.length ? ((extraPayments[extraPayments.length - 1].month || 0) + 1) : 1;
            extraPayments.push({ month: nextMonth, amount: 0 });
            renderExtraPayments();
            persistExtraPayments();
        }

        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabPanels = document.querySelectorAll('.tab-panel');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const target = button.dataset.tab;

                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabPanels.forEach(panel => panel.classList.remove('active'));

                    button.classList.add('active');
                    const panel = document.getElementById(target);
                    if (panel) panel.classList.add('active');
                });
            });
        }

        function saveToSessionStorage() {
            gridInputIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    sessionStorage.setItem(`calculateGrid_${id}`, element.value);
                }
            });
        }

        function loadFromSessionStorage() {
            const hasStoredData = sessionStorage.getItem('calculateGrid_cv') !== null;
            gridInputIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    if (hasStoredData) {
                        // Load from session storage
                        const storedValue = sessionStorage.getItem(`calculateGrid_${id}`);
                        if (storedValue !== null) {
                            element.value = storedValue;
                        }
                    } else {
                        // Save default values to session storage
                        const defaultValue = defaultValues[id];
                        if (defaultValue !== undefined) {
                            element.value = defaultValue;
                            sessionStorage.setItem(`calculateGrid_${id}`, defaultValue);
                        }
                    }
                }
            });
        }

        function calculateRound(cv, entry, startpTH, downEntry, supportDrawdown, pf, numberOrder, perday) {
            // Price Calculations
            const startpUSD = startpTH / cv;
            const pd = supportDrawdown / downEntry;
            const ddUSD = startpUSD / pd;
            const ddTHB = ddUSD * cv;

            // Entry & Total Calculations
            const entryTH = entry * cv;
            const ttPF = entryTH / 100 * pf;
            const tt = entryTH + ttPF;
            const total = ttPF * numberOrder;

            // Per Day Calculations
            const day1Ratio = 30 / perday;
            const day1Total = day1Ratio * total;

            return {
                startpUSD,
                pd,
                ddUSD,
                ddTHB,
                entryTH,
                ttPF,
                tt,
                total,
                day1Ratio,
                day1Total,
                entry,
                startpTH
            };
        }

        function calculateGrid() {
            const cv = parseFloat(document.getElementById('cv').value) || 0;
            let entry = parseFloat(document.getElementById('entry').value) || 0;
            let startpTH = parseFloat(document.getElementById('startpTH').value) || 0;
            const downEntry = parseFloat(document.getElementById('downEntry').value) || 0;
            const supportDrawdown = parseFloat(document.getElementById('supportDrawdown').value) || 80;
            const pf = parseFloat(document.getElementById('pf').value) || 0;
            const numberOrder = parseFloat(document.getElementById('numberOrder').value) || 0;
            const perday = parseFloat(document.getElementById('perday').value) || 1;
            const numRounds = parseInt(document.getElementById('numRounds').value) || 1;

            // Calculate first round (using original values)
            const firstRound = calculateRound(cv, entry, startpTH, downEntry, supportDrawdown, pf, numberOrder, perday);

            // Update main display with first round
            document.getElementById('startpUSD').textContent = firstRound.startpUSD.toFixed(2);
            document.getElementById('pd').textContent = firstRound.pd.toFixed(2);
            document.getElementById('ddUSD').textContent = firstRound.ddUSD.toFixed(2);
            document.getElementById('ddTHB').textContent = firstRound.ddTHB.toFixed(2);
            document.getElementById('entryTH').textContent = firstRound.entryTH.toFixed(2);
            document.getElementById('ttPF').textContent = firstRound.ttPF.toFixed(2);
            document.getElementById('tt').textContent = firstRound.tt.toFixed(2);
            document.getElementById('total').textContent = firstRound.total.toFixed(2);
            document.getElementById('day1Ratio').textContent = firstRound.day1Ratio.toFixed(2);
            document.getElementById('day1Total').textContent = firstRound.day1Total.toFixed(2);

            // Calculate and display all rounds in table
            const roundsTableBody = document.getElementById('roundsTableBody');
            roundsTableBody.innerHTML = '';

            let currentEntry = entry;
            let currentStartpTH = startpTH;
            const allRounds = [];

            // Calculate all rounds
            for (let i = 0; i < numRounds; i++) {
                if (i === 0) {
                    // First round uses original values
                    allRounds.push(firstRound);
                } else {
                    // Use DD is USD from previous round as Entry ($)
                    currentEntry = allRounds[i - 1].ddUSD;
                    // Add Day 1 Total from previous round to Startp TH
                    currentStartpTH = currentStartpTH + allRounds[i - 1].day1Total;

                    const roundResult = calculateRound(cv, currentEntry, currentStartpTH, downEntry, supportDrawdown, pf, numberOrder, perday);
                    allRounds.push(roundResult);
                }
            }

            // Display all rounds in table
            allRounds.forEach((round, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="round-number">${index + 1}</td>
                    <td>${round.entry.toFixed(2)}</td>
                    <td>${round.startpTH.toFixed(2)}</td>
                    <td>${round.startpUSD.toFixed(2)}</td>
                    <td>${round.ddUSD.toFixed(2)}</td>
                    <td>${round.ddTHB.toFixed(2)}</td>
                    <td>${round.entryTH.toFixed(2)}</td>
                    <td>${round.ttPF.toFixed(2)}</td>
                    <td>${round.tt.toFixed(2)}</td>
                    <td>${round.total.toFixed(2)}</td>
                    <td>${round.day1Ratio.toFixed(2)}</td>
                    <td>${round.day1Total.toFixed(2)}</td>
                `;
                roundsTableBody.appendChild(row);
            });
        }

        function initializeGridCalculator() {
            loadFromSessionStorage();
            gridInputIds.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', () => {
                        saveToSessionStorage();
                        calculateGrid();
                    });
                }
            });
            calculateGrid();
        }

        function formatMoneyTH(value) {
            return value.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function simulateLoanSchedule(payment, r, n, applyExtra = true) {
            const rows = [];
            let balance = Number(document.getElementById('principal').value || 0);
            let totalInterest = 0;
            let totalPaid = 0;

            for (let month = 1; month <= n; month++) {
                if (balance <= 0) break;

                const beginBalance = balance;
                const interest = beginBalance * r;
                let principalPaid = payment - interest;
                principalPaid = Math.max(principalPaid, 0);

                let extraPay = 0;
                if (applyExtra) {
                    extraPayments.forEach(extra => {
                        const extraMonth = Number(extra.month) || 0;
                        const extraAmount = Number(extra.amount) || 0;
                        if (extraMonth > 0 && extraAmount > 0 && month === extraMonth) {
                            extraPay += extraAmount;
                        }
                    });
                }

                let endBalance = beginBalance - principalPaid - extraPay;
                if (endBalance < 0) {
                    const diff = -endBalance;
                    principalPaid += diff;
                    endBalance = 0;
                }

                totalInterest += interest;
                totalPaid += payment + extraPay;

                rows.push({
                    month,
                    beginBalance,
                    payment,
                    interest,
                    principalPaid,
                    extraPay,
                    endBalance
                });

                balance = endBalance;
                if (balance <= 0) break;
            }

            return { rows, totalInterest, totalPaid };
        }

        function calculateLoanSchedule() {
            const P = Number(document.getElementById('principal').value || 0);
            const annualRate = Number(document.getElementById('annualRate').value || 0);
            const n = Number(document.getElementById('months').value || 0);

            if (!P || !annualRate || !n) {
                alert('กรุณากรอกยอดกู้, ดอกเบี้ย และจำนวนงวด');
                return;
            }

            const r = annualRate / 100 / 12;
            const payment = P * r / (1 - Math.pow(1 + r, -n));

            const baseline = simulateLoanSchedule(payment, r, n, false);
            const withExtra = simulateLoanSchedule(payment, r, n, true);

            const tbody = document.querySelector('#loanScheduleTable tbody');
            tbody.innerHTML = '';
            withExtra.rows.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.month}</td>
                    <td>${formatMoneyTH(row.beginBalance)}</td>
                    <td>${formatMoneyTH(row.payment)}</td>
                    <td>${formatMoneyTH(row.interest)}</td>
                    <td>${formatMoneyTH(row.principalPaid)}</td>
                    <td>${formatMoneyTH(row.extraPay)}</td>
                    <td>${formatMoneyTH(row.endBalance)}</td>
                `;
                tbody.appendChild(tr);
            });

            const summary = document.getElementById('loanSummary');
            summary.innerHTML = `
                <div class="section-title">สรุปผล</div>
                <div><b>ค่างวดต่อเดือน (เดิม):</b> ${formatMoneyTH(payment)} บาท</div>
                <div><b>ยอดดอกเบี้ยทั้งหมด (ประมาณ - ไม่โปะ):</b> ${formatMoneyTH(baseline.totalInterest)} บาท</div>
                <div><b>ยอดดอกเบี้ยทั้งหมด (ประมาณ - มีโปะ):</b> ${formatMoneyTH(withExtra.totalInterest)} บาท</div>
                <div><b>ยอดเงินที่จ่ายทั้งหมด (ต้น + ดอก + โปะ):</b> ${formatMoneyTH(withExtra.totalPaid)} บาท</div>
            `;
        }

        function initializeLoanCalculator() {
            loanInputIds.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', calculateLoanSchedule);
                }
            });
            const addExtraBtn = document.getElementById('addExtraPaymentBtn');
            if (addExtraBtn) {
                addExtraBtn.addEventListener('click', addExtraPayment);
            }
            loadExtraPayments();
            calculateLoanSchedule();
        }

        function initializeApp() {
            setupTabs();
            initializeGridCalculator();
            initializeLoanCalculator();
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
</body>
</html>
